{{define "modals/outModal"}}
<a-modal id="out-modal" v-model="outModal.visible" :title="outModal.title" @ok="outModal.ok"
         :confirm-loading="outModal.confirmLoading" :closable="true" :mask-closable="false"
         :ok-button-props="{ props: { disabled: !outModal.isValid } }" :style="{ overflow: 'hidden' }"
         :ok-text="outModal.okText" cancel-text='{{ i18n "close" }}' :class="themeSwitcher.currentTheme">
         {{template "form/outbound"}}
</a-modal>
<script>

    const outModal = {
        title: '',
        visible: false,
        confirmLoading: false,
        okText: '{{ i18n "sure" }}',
        isEdit: false,
        confirm: null,
        outbound: new Outbound(),
        jsonMode: false,
        link: '',
        cm: null,
        duplicateTag: false,
        isValid: true,
        activeKey: '1',
        tags: [],
        ok() {
            ObjectUtil.execute(outModal.confirm, outModal.outbound.toJson());
        },
        show({ title='', okText='{{ i18n "sure" }}', outbound, confirm=(outbound)=>{}, isEdit=false, tags=[]  }) {
            this.title = title;
            this.okText = okText;
            this.confirm = confirm;
            this.jsonMode = false;
            this.link = '';
            this.activeKey = '1';
            this.visible = true;
            this.outbound = isEdit ? Outbound.fromJson(outbound) : new Outbound();
            this.isEdit = isEdit;
            this.tags = tags;
            this.check()
        },
        close() {
            outModal.visible = false;
            outModal.loading(false);
        },
        loading(loading=true) {
            outModal.confirmLoading = loading;
        },
        check(){
            if(outModal.outbound.tag == '' || outModal.tags.includes(outModal.outbound.tag)){
                this.duplicateTag = true;
                this.isValid = false;
            } else {
                this.duplicateTag = false;
                this.isValid = true;
            }
        },
        toggleJson(jsonTab) {
            textAreaObj = document.getElementById('outboundJson');
            if(jsonTab){
                if(this.cm != null) {
                        this.cm.toTextArea();
                        this.cm=null;
                }
                textAreaObj.value = JSON.stringify(this.outbound.toJson(), null, 2);
                const cmOptions = (typeof app !== 'undefined' && app.cmOptions) ? app.cmOptions : {
                    lineNumbers: true,
                    mode: "application/json",
                    lint: true,
                    styleActiveLine: true,
                    matchBrackets: true,
                    theme: "xq",
                    autoCloseTags: true,
                    lineWrapping: true,
                    indentUnit: 2,
                    indentWithTabs: true,
                    smartIndent: true,
                    tabSize: 2,
                    lineWiseCopyCut: false,
                    foldGutter: true,
                    gutters: [
                        "CodeMirror-lint-markers",
                        "CodeMirror-linenumbers",
                        "CodeMirror-foldgutter",
                    ],
                };
                this.cm = CodeMirror.fromTextArea(textAreaObj, cmOptions);
                this.cm.on('change',editor => {
                    value = editor.getValue();
                    if(this.isJsonString(value)){
                        this.outbound = Outbound.fromJson(JSON.parse(value));
                        this.check();
                    }
                });
                this.activeKey = '2';
            } else {
                if(this.cm != null) {
                        this.cm.toTextArea();
                        this.cm=null;
                }
                this.activeKey = '1';
            }
        },
        isJsonString(str) {
            try {
                JSON.parse(str);
            } catch (e) {
                return false;
            }
            return true;
        },
    };

    new Vue({
        delimiters: ['[[', ']]'],
        el: '#out-modal',
        data: {
            outModal: outModal,
            outboundModal: null, // Not used in this modal
            multiNodeMode: false,
            availableNodes: [],
            get themeSwitcher() {
                return typeof themeSwitcher !== 'undefined' ? themeSwitcher : { currentTheme: 'light' };
            },
            get outbound() {
                return outModal.outbound;
            },
            get currentModal() {
                return outModal;
            },
            get showRemark() {
                return false; // Not shown in template mode
            },
            get showNodesSection() {
                return false; // Not shown in template mode
            },
            get availableNodesList() {
                return [];
            },
            get nodeConflictErrorText() {
                return '';
            },
        },
        async mounted() {
            // Load multi-node mode
            try {
                const msg = await HttpUtil.post("/panel/setting/all");
                if (msg && msg.success && msg.obj) {
                    this.multiNodeMode = Boolean(msg.obj.multiNodeMode) || false;
                }
            } catch (e) {
                console.warn("Failed to load multi-node mode:", e);
            }
        },
        methods: {
            streamNetworkChange() {
                if (this.outModal.outbound.protocol == Protocols.VLESS && !outModal.outbound.canEnableTlsFlow()) {
                    delete this.outModal.outbound.settings.flow;
                }
            },
            canEnableTls() {
                return this.outModal.outbound.canEnableTls();
            },
            convertLink(){
                newOutbound = Outbound.fromLink(outModal.link);
                if(newOutbound){
                    this.outModal.outbound = newOutbound;
                    this.outModal.toggleJson(true);
                    this.outModal.check();
                    if (typeof Vue !== 'undefined' && Vue.prototype && Vue.prototype.$message) {
                        Vue.prototype.$message.success('Link imported successfully...');
                    }
                    outModal.link = '';
                } else {
                    if (typeof Vue !== 'undefined' && Vue.prototype && Vue.prototype.$message) {
                        Vue.prototype.$message.error('Wrong Link!');
                    }
                    outModal.link = '';
                }
            },
            isNodeDisabled() {
                return false; // Not applicable for template outbounds
            },
            onNodeIdsChange() {
                // Not applicable for template outbounds
            },
            filterNodeOption() {
                return true;
            },
        },
    });

</script>
{{end}}
